<!DOCTYPE html><meta charset='UTF-8'><html><head><link rel='stylesheet' href='katex/katex.min.css'    integrity='sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X'    crossorigin='anonymous'><!-- The loading of KaTeX is deferred to speed up page rendering --><title> A Universe of Sorts </title><style>@font-face {font-family: 'Blog Mono'; src: url('/static/iosevka-fixed-extended.ttf');}@font-face {font-family: 'Blog Text'; src: url('/static/Exo2-Regular.ttf');}html { font-size: 100%; }html,body { text-size-adjust: none; -webkit-text-size-adjust: none; -moz-text-size-adjust: none; -ms-text-size-adjust: none; } body { background-color: #FFFFFF; color: #000000;  font-family: 'Blog Text', sans-serif; font-size: 18px; line-height: 1.4em;  max-width: 100%; overflow-x: hidden; }
img { display:block; }.container { overflow-x: hidden; max-width:100%; }@media (max-width: 480px) { .container { margin-left: 5%; margin-right: 2%; } body { font-size: 40px; } }@media (max-width: 1024px) { .container { margin-left: 5%; margin-right: 2%; } body { font-size: 40px; } }@media (min-width: 1024px) { .container { margin-left: 30%; margin-right: 25%; } }.image { }
a:hover { color: #1a73e8; text-decoration: underline;  }
a { color: #1a73e8; text-decoration: none; }
a:visited { color: #1a73e8; text-decoration: none; }
a:active { color: #1a73e8; text-decoration: none; }

blockquote { margin-left: 0px; margin-right: 0px; } .code, .latexblock, blockquote { border-left-color:#BBB;  border-left-style: solid;      border-left-width: 1px; }.code pre, blockquote { padding-left: 10px; }
 .code { font-family: 'Blog Mono', monospace; font-size: 90%;  }.latexblock, blockquote, .code, code { margin-top: 10px; margin-bottom: 10px; padding-bottom: 5px; padding-top: 5px; background-color: #FFFFFF; }.code, code { background-color: #FFFFFF; width: 100%; }.latexblock { line-height: 1em } .latexblock {  width: 100%; overflow-x: auto; white-space: nowrap; } .code pre { width: 100%; overflow-x: auto; margin: 0px; overflow-y: hidden; padding-top: 5px; padding-bottom: 5px; margin: 0px; }
.latexinline { white-space: nowrap }.code { white-space: nowrap }pre, code, kbd, samp, tt{ font-family:'Blog Mono',monospace; }ul, ol { list-style-position: inside; padding-left: 0; }</style></head><body><div class='container'><h2><a id=-katex-in-duktape href='#-katex-in-duktape'> ยง </a> Katex in duktape</h2>
Here's some code to use <code>duktape</code>, a lightweight JavaScript interpreter
to run <code>katex</code> when implementing a custom static site generator [as I
am doing for this website]. This seems to be <i>way more lightweight</i>
than relying on Node, since we don't need to pay for inter-procedure-calls.
I haven't benchmarked my static site generator against others, but I would
be surprised if it is much faster, since it is written entirely in C, and
avoids anything 'expensive'.
<div class='code'><!-- Generator: GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt><b><font color="#000080">#include</font></b> <font color="#FF0000">"duktape.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdio.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;assert.h&gt;</font>
<b><font color="#0000FF">typedef</font></b> <font color="#009900">long</font> <font color="#009900">long</font> ll<font color="#990000">;</font>

<font color="#009900">void</font> <b><font color="#000000">vduk_print_stack</font></b><font color="#990000">(</font><font color="#008080">duk_context</font> <font color="#990000">*</font>ctx<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font> <font color="#990000">*</font>fmt<font color="#990000">,</font> <font color="#008080">va_list</font> args<font color="#990000">)</font><font color="#FF0000">{</font>
    <font color="#009900">char</font> <font color="#990000">*</font>outstr <font color="#990000">=</font> nullptr<font color="#990000">;</font>
    <b><font color="#000000">vasprintf</font></b><font color="#990000">(&amp;</font>outstr<font color="#990000">,</font> fmt<font color="#990000">,</font> args<font color="#990000">);</font>
    <b><font color="#000000">assert</font></b><font color="#990000">(</font>outstr<font color="#990000">);</font>

    <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">vvv%svvv</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> outstr<font color="#990000">);</font>
    <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"[TOP OF STACK]</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> <font color="#009900">int</font> len <font color="#990000">=</font> <b><font color="#000000">duk_get_top</font></b><font color="#990000">(</font>ctx<font color="#990000">);</font>
    <b><font color="#0000FF">for</font></b><font color="#990000">(</font><font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font> i <font color="#990000">&lt;=</font> len<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#000000">duk_dup</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font>i<font color="#990000">);</font>
        <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"stk[-%2d] = %20s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> i<font color="#990000">,</font> <b><font color="#000000">duk_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
        <b><font color="#000000">duk_pop</font></b><font color="#990000">(</font>ctx<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"^^^^^^^</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>
<font color="#FF0000">}</font>


<font color="#009900">void</font> <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font><font color="#008080">duk_context</font> <font color="#990000">*</font>ctx<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#009900">char</font> <font color="#990000">*</font>fmt<font color="#990000">,</font> <font color="#990000">...)</font> <font color="#FF0000">{</font>
    <font color="#008080">va_list</font> args<font color="#990000">;</font>
    <b><font color="#000000">va_start</font></b><font color="#990000">(</font>args<font color="#990000">,</font> fmt<font color="#990000">);</font>
    <b><font color="#000000">vduk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> fmt<font color="#990000">,</font> args<font color="#990000">);</font>
    <b><font color="#000000">va_end</font></b><font color="#990000">(</font>args<font color="#990000">);</font>
<font color="#FF0000">}</font>
<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">()</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">const</font></b> <font color="#009900">char</font> <font color="#990000">*</font>latex_to_compile <font color="#990000">=</font> <font color="#FF0000">"</font><font color="#CC33CC">\\</font><font color="#FF0000">int_0^</font><font color="#CC33CC">\\</font><font color="#FF0000">infty f(x) dx"</font><font color="#990000">;</font>
    <b><font color="#0000FF">const</font></b> <font color="#009900">char</font> <font color="#990000">*</font>broken_latex_to_compile <font color="#990000">=</font> <font color="#FF0000">"</font><font color="#CC33CC">\\</font><font color="#FF0000">int_0^</font><font color="#CC33CC">\\</font><font color="#FF0000">infty </font><font color="#CC33CC">\\</font><font color="#FF0000">foobar f(x) dx"</font><font color="#990000">;</font>

    <i><font color="#9A1900">// FILE *fkatex = fopen("/home/bollu/blog/katex/katex.min.js", "rb");</font></i>
    <font color="#008080">FILE</font> <font color="#990000">*</font>fkatex <font color="#990000">=</font> <b><font color="#000000">fopen</font></b><font color="#990000">(</font><font color="#FF0000">"/home/bollu/blog/katex/katex.min.js"</font><font color="#990000">,</font> <font color="#FF0000">"rb"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fkatex <font color="#990000">==</font> nullptr<font color="#990000">)</font> <font color="#FF0000">{</font> <b><font color="#000000">assert</font></b><font color="#990000">(</font>false <font color="#990000">&amp;&amp;</font> <font color="#FF0000">"unable to open katex.min.js"</font><font color="#990000">);</font> <font color="#FF0000">}</font>

    <b><font color="#000000">fseek</font></b><font color="#990000">(</font>fkatex<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> SEEK_END<font color="#990000">);</font>
    <b><font color="#0000FF">const</font></b> <font color="#008080">ll</font> len <font color="#990000">=</font> <b><font color="#000000">ftell</font></b><font color="#990000">(</font>fkatex<font color="#990000">);</font> <b><font color="#000000">fseek</font></b><font color="#990000">(</font>fkatex<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> SEEK_SET<font color="#990000">);</font>
    <font color="#009900">char</font> <font color="#990000">*</font>js <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">char</font> <font color="#990000">*)</font><b><font color="#000000">calloc</font></b><font color="#990000">(</font><b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font><font color="#009900">char</font><font color="#990000">),</font> len <font color="#990000">+</font> <font color="#993399">10</font><font color="#990000">);</font>

    <b><font color="#0000FF">const</font></b> <font color="#008080">ll</font> nread <font color="#990000">=</font> <b><font color="#000000">fread</font></b><font color="#990000">(</font>js<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> len<font color="#990000">,</font> fkatex<font color="#990000">);</font>
    <b><font color="#000000">assert</font></b><font color="#990000">(</font>nread <font color="#990000">==</font> len<font color="#990000">);</font>
    <font color="#008080">duk_context</font> <font color="#990000">*</font>ctx <font color="#990000">=</font> <b><font color="#000000">duk_create_heap_default</font></b><font color="#990000">();</font>
    <b><font color="#000000">duk_push_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"katex.min.js"</font><font color="#990000">);</font> <i><font color="#9A1900">// for error message</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">duk_pcompile_string_filename</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> js<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#000000">fprintf</font></b><font color="#990000">(</font>stderr<font color="#990000">,</font> <font color="#FF0000">"===katex.min.js compliation failed===</font><font color="#CC33CC">\n</font><font color="#FF0000">%s</font><font color="#CC33CC">\n</font><font color="#FF0000">===</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> 
                <b><font color="#000000">duk_safe_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
        <b><font color="#000000">assert</font></b><font color="#990000">(</font>false <font color="#990000">&amp;&amp;</font> <font color="#FF0000">"unable to compile katex.min.js"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#000000">fprintf</font></b><font color="#990000">(</font>stderr<font color="#990000">,</font> <font color="#FF0000">"===katex.min.js successfully complied===</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">);</font>

        <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"Stack afer compilation"</font><font color="#990000">,</font> __LINE__<font color="#990000">);</font>
        <b><font color="#000000">duk_call</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">);</font>   
        <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"program result: %s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> <b><font color="#000000">duk_safe_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>

    <font color="#FF0000">}</font>



    <i><font color="#9A1900">// https://wiki.duktape.org/howtofunctioncalls</font></i>
    <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> __LINE__<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b><font color="#990000">(</font><b><font color="#000000">duk_peval_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"katex"</font><font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"eval failed: %s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> <b><font color="#000000">duk_safe_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
        <b><font color="#000000">assert</font></b><font color="#990000">(</font><font color="#993399">0</font> <font color="#990000">&amp;&amp;</font> <font color="#FF0000">"unable to find the katex object"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>  <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> __LINE__<font color="#990000">);</font>
    <font color="#FF0000">}</font>

    <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> __LINE__<font color="#990000">);</font>
    <b><font color="#000000">duk_push_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"renderToString"</font><font color="#990000">);</font>
    <b><font color="#000000">duk_push_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> latex_to_compile<font color="#990000">);</font>

    <b><font color="#000000">duk_print_stack</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> __LINE__<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b><font color="#990000">(</font><b><font color="#000000">duk_pcall_prop</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">3</font><font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">)</font> <font color="#990000">==</font> DUK_EXEC_SUCCESS<font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"===katexed output:===</font><font color="#CC33CC">\n</font><font color="#FF0000">%s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> <b><font color="#000000">duk_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        <b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">"unable to katex: %s</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> <b><font color="#000000">duk_to_string</font></b><font color="#990000">(</font>ctx<font color="#990000">,</font> <font color="#990000">-</font><font color="#993399">1</font><font color="#990000">));</font>
        <b><font color="#000000">assert</font></b><font color="#990000">(</font>false <font color="#990000">&amp;&amp;</font> <font color="#FF0000">"unable to katex input"</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
 
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</div>
</container></body></html>